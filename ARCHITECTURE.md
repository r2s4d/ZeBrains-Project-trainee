# 🏗️ Архитектура AI News Assistant Bot

## 📋 Обзор архитектуры

AI News Assistant Bot построен на **сервис-ориентированной архитектуре** с 20+ сервисами, обеспечивающей высокую масштабируемость, надежность и расширяемость системы.

## 🎯 Принципы архитектуры

### **1. Разделение ответственности**
- Каждый сервис отвечает за конкретную область функциональности
- Четкие границы между сервисами
- Минимальные зависимости между компонентами

### **2. Асинхронная обработка**
- Все операции выполняются асинхронно
- Неблокирующая обработка запросов
- Высокая производительность при множественных операциях

### **3. Устойчивость к сбоям**
- Восстановление состояния после перезапуска
- Retry логика с circuit breaker
- Fallback механизмы для критических операций

## 🔧 Основные компоненты

### **1. Telegram Bot Layer**
```
┌─────────────────────────────────────┐
│           Telegram Bot API          │
│        (python-telegram-bot)        │
├─────────────────────────────────────┤
│         User API (Telethon)         │
│      (для публикации сообщений)     │
└─────────────────────────────────────┘
```

**Ответственность:**
- Обработка команд и callback кнопок
- Интерактивная модерация
- Публикация сообщений в канал

### **2. Service Layer (20 сервисов)**

#### **AI Services**
```
┌─────────────────────────────────────┐
│        AIAnalysisService            │
│     (ProxyAPI интеграция)           │
├─────────────────────────────────────┤
│     DuplicateDetectionService       │
│    (ML для обнаружения дубликатов)  │
└─────────────────────────────────────┘
```

#### **News Processing Services**
```
┌─────────────────────────────────────┐
│       NewsParserService             │
│   (автоматический парсинг)          │
├─────────────────────────────────────┤
│    MorningDigestService             │
│    (создание утренних дайджестов)   │
├─────────────────────────────────────┤
│  FinalDigestFormatterService        │
│    (финальное форматирование)       │
└─────────────────────────────────────┘
```

#### **Interaction Services**
```
┌─────────────────────────────────────┐
│     CuratorApprovalService          │
│    (интерактивная модерация)        │
├─────────────────────────────────────┤
│   ExpertInteractionService          │
│   (взаимодействие с экспертами)     │
├─────────────────────────────────────┤
│    InteractiveModerationService     │
│      (модерация новостей)           │
└─────────────────────────────────────┘
```

#### **Infrastructure Services**
```
┌─────────────────────────────────────┐
│  PostgreSQLDatabaseService          │
│       (основная БД)                 │
├─────────────────────────────────────┤
│     BotSessionService               │
│    (управление состояниями)         │
├─────────────────────────────────────┤
│   TelegramSessionDBService          │
│    (управление Telegram сессиями)   │
├─────────────────────────────────────┤
│      SchedulerService               │
│     (планировщик задач)             │
└─────────────────────────────────────┘
```

### **3. Data Layer**

#### **PostgreSQL (основная БД)**
```
┌─────────────────────────────────────┐
│              Models                 │
│  ┌─────────────────────────────────┐ │
│  │ News, Expert, Comment, Source   │ │
│  ├─────────────────────────────────┤ │
│  │ BotSession, DigestSession       │ │
│  ├─────────────────────────────────┤ │
│  │ Post, Summary, NewsSource       │ │
│  └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

#### **SQLite (кэш)**
```
┌─────────────────────────────────────┐
│           Cache Layer               │
│  ┌─────────────────────────────────┐ │
│  │ AI запросы (саммари, анализ)    │ │
│  ├─────────────────────────────────┤ │
│  │ Временные данные                │ │
│  └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

## 🔄 Поток данных

### **1. Парсинг новостей**
```
Telegram Channels → NewsParserService → AIAnalysisService → PostgreSQL
                                      ↓
                               DuplicateDetectionService
```

### **2. Создание дайджеста**
```
PostgreSQL → MorningDigestService → CuratorApprovalService → InteractiveModerationService
```

### **3. Экспертная работа**
```
InteractiveModerationService → ExpertInteractionService → PostgreSQL
```

### **4. Публикация**
```
PostgreSQL → FinalDigestFormatterService → CuratorApprovalService → TelegramUserPublisher
```

## ⚙️ Конфигурация

### **Централизованная система настроек**
```
┌─────────────────────────────────────┐
│        src/config/settings.py       │
│  ┌─────────────────────────────────┐ │
│  │ DatabaseConfig                  │ │
│  ├─────────────────────────────────┤ │
│  │ TelegramConfig                  │ │
│  ├─────────────────────────────────┤ │
│  │ AIConfig                        │ │
│  ├─────────────────────────────────┤ │
│  │ SecurityConfig                  │ │
│  ├─────────────────────────────────┤ │
│  │ TimeoutConfig                   │ │
│  └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

## 🔒 Безопасность

### **Многоуровневая защита**
```
┌─────────────────────────────────────┐
│     TelegramSecurityService         │
│  ┌─────────────────────────────────┐ │
│  │ Шифрование сессий              │ │
│  ├─────────────────────────────────┤ │
│  │ Валидация входных данных        │ │
│  ├─────────────────────────────────┤ │
│  │ Rate limiting                   │ │
│  └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

## 📊 Мониторинг и логирование

### **Структурированное логирование**
- **Контекстные логи** для каждого сервиса
- **Отслеживание производительности** AI запросов
- **Мониторинг состояния** всех компонентов
- **Алерты** при критических ошибках

## 🚀 Производительность

### **Оптимизации**
- **Кэширование AI запросов** (SQLite)
- **Асинхронная обработка** всех операций
- **Параллельное восстановление** сессий
- **Умное разделение** длинных сообщений

### **Масштабируемость**
- **Горизонтальное масштабирование** сервисов
- **Независимые компоненты** для легкого развертывания
- **Модульная архитектура** для добавления новых функций

## 🔄 Автоматизация

### **Планировщик задач**
```
┌─────────────────────────────────────┐
│         SchedulerService            │
│  ┌─────────────────────────────────┐ │
│  │ Парсинг новостей (каждый час)   │ │
│  ├─────────────────────────────────┤ │
│  │ Утренние дайджесты (9:00)       │ │
│  ├─────────────────────────────────┤ │
│  │ Очистка кэша (каждый час)       │ │
│  ├─────────────────────────────────┤ │
│  │ Очистка сессий (каждые 30 мин)  │ │
│  └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

## 📈 Статистика архитектуры

### **Масштаб проекта**
- **Строк кода**: 20,000+
- **Сервисов**: 20 активных
- **Моделей данных**: 8 с отношениями
- **API интеграции**: Bot API + User API + ProxyAPI
- **База данных**: PostgreSQL + SQLite кэш

### **Производительность**
- **AI запросы**: кэширование до 90% экономии
- **Восстановление сессий**: параллельная обработка
- **Автоматизация**: 100% покрытие критических процессов

## 🔮 Расширяемость

### **Добавление новых сервисов**
1. Создать новый сервис в `src/services/`
2. Добавить в конфигурацию `src/config/settings.py`
3. Интегрировать в основной бот `src/bot/bot.py`
4. Обновить документацию

### **Добавление новых API**
1. Создать новый обработчик в `src/bot/bot.py`
2. Добавить callback обработчик при необходимости
3. Обновить состояния в `BotSessionService`
4. Добавить в API документацию

---

*Архитектура спроектирована для высокой производительности, надежности и легкой расширяемости.*
