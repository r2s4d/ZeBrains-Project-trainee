"""
–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–µ–∞–ª—å–Ω–æ–π –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö PostgreSQL.
–ó–∞–º–µ–Ω–∏—Ç mock DatabaseService –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ SQL –∑–∞–ø—Ä–æ—Å—ã.
"""

from typing import List, Optional, Dict
from sqlalchemy.orm import Session
from datetime import datetime
import logging

from src.models.database import Source, News, Expert, Comment, NewsSource

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logger = logging.getLogger(__name__)

class PostgreSQLDatabaseService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–µ–∞–ª—å–Ω–æ–π PostgreSQL –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö."""
    
    def __init__(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞."""
        self.engine = None
        self.SessionLocal = None
        # –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —ç–∫—Å–ø–µ—Ä—Ç–∞ –Ω–µ–¥–µ–ª–∏
        self.selected_expert_id = None
        self._initialize_connection()
    
    def _initialize_connection(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL."""
        try:
            from sqlalchemy import create_engine
            from sqlalchemy.orm import sessionmaker
            from src.config.database_config import DatabaseConfig
            
            # –°–æ–∑–¥–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL
            connection_string = DatabaseConfig.get_connection_string()
            logger.info(f"üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL: {connection_string}")
            
            self.engine = create_engine(connection_string)
            self.SessionLocal = sessionmaker(bind=self.engine)
            
            # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
            with self.get_session() as session:
                from sqlalchemy import text
                session.execute(text("SELECT 1"))
                logger.info("‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ")
                
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ PostgreSQL: {e}")
            self.engine = None
            self.SessionLocal = None
    
    def get_session(self) -> Session:
        """–ü–æ–ª—É—á–∞–µ—Ç —Å–µ—Å—Å–∏—é PostgreSQL."""
        if not self.SessionLocal:
            raise Exception("PostgreSQL –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
        return self.SessionLocal()
    
    
    # ===== –†–ê–ë–û–¢–ê –° –ò–°–¢–û–ß–ù–ò–ö–ê–ú–ò (Sources) =====
    
    
    def get_all_sources(self) -> List[Source]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –Ω–æ–≤–æ—Å—Ç–µ–π.
        
        Returns:
            List[Source]: –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
        """
        with self.get_session() as db:
            try:
                sources = db.query(Source).all()
                logger.info(f"üìä –ü–æ–ª—É—á–µ–Ω–æ {len(sources)} –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤")
                return sources
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤: {e}")
                return []
    
    
    # ===== –†–ê–ë–û–¢–ê –° –ù–û–í–û–°–¢–Ø–ú–ò (News) =====
    
    def get_all_news(self) -> List[News]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –Ω–æ–≤–æ—Å—Ç–∏.
        
        Returns:
            List[News]: –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –Ω–æ–≤–æ—Å—Ç–µ–π
        """
        with self.get_session() as db:
            try:
                news_list = db.query(News).all()
                logger.info(f"üìä –ü–æ–ª—É—á–µ–Ω–æ {len(news_list)} –Ω–æ–≤–æ—Å—Ç–µ–π")
                return news_list
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –≤—Å–µ—Ö –Ω–æ–≤–æ—Å—Ç–µ–π: {e}")
                return []
    
    
    
    
    

    async def get_news_since(self, start_time: datetime) -> List[News]:
        """–ü–æ–ª—É—á–∏—Ç—å –Ω–æ–≤–æ—Å—Ç–∏, –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏."""
        try:
            with self.get_session() as db:
                news_list = db.query(News).filter(News.published_at >= start_time).all()
                logger.info(f"üìä –ü–æ–ª—É—á–µ–Ω–æ {len(news_list)} –Ω–æ–≤–æ—Å—Ç–µ–π —Å {start_time}")
                return news_list
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤–æ—Å—Ç–µ–π —Å {start_time}: {e}")
            return []
    
    # ===== –ú–ï–¢–û–î–´ –î–õ–Ø –§–ò–ù–ê–õ–¨–ù–û–ì–û –î–ê–ô–î–ñ–ï–°–¢–ê =====
    
    def get_approved_news_for_digest(self, limit: int = 5) -> List[News]:
        """
        –ü–æ–ª—É—á–∏—Ç—å –æ–¥–æ–±—Ä–µ–Ω–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –¥–∞–π–¥–∂–µ—Å—Ç–∞.
        
        Args:
            limit: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤–æ—Å—Ç–µ–π
            
        Returns:
            List[News]: –°–ø–∏—Å–æ–∫ –æ–¥–æ–±—Ä–µ–Ω–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π
        """
        try:
            with self.get_session() as session:
                # –ü–æ–ª—É—á–∞–µ–º –æ–¥–æ–±—Ä–µ–Ω–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ –¥–∞—Ç–µ
                news_list = session.query(News).filter(
                    News.status == "approved"
                ).order_by(News.created_at.desc()).limit(limit).all()
                
                logger.info(f"üìä –ü–æ–ª—É—á–µ–Ω–æ {len(news_list)} –æ–¥–æ–±—Ä–µ–Ω–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π –¥–ª—è –¥–∞–π–¥–∂–µ—Å—Ç–∞")
                return news_list
                
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–¥–æ–±—Ä–µ–Ω–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π: {e}")
            return []
    
    def get_expert_of_week(self) -> Optional[Expert]:
        """
        –ü–æ–ª—É—á–∏—Ç—å —ç–∫—Å–ø–µ—Ä—Ç–∞ –Ω–µ–¥–µ–ª–∏.
        
        Returns:
            Expert: –≠–∫—Å–ø–µ—Ä—Ç –Ω–µ–¥–µ–ª–∏ –∏–ª–∏ None
        """
        try:
            with self.get_session() as session:
                # –ï—Å–ª–∏ –µ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —ç–∫—Å–ø–µ—Ä—Ç –≤ –ø–∞–º—è—Ç–∏, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ
                if self.selected_expert_id:
                    expert = session.query(Expert).filter(Expert.id == self.selected_expert_id).first()
                    if expert:
                        logger.info(f"üë§ –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —ç–∫—Å–ø–µ—Ä—Ç–∞ –Ω–µ–¥–µ–ª–∏: {expert.name}")
                        return expert
                
                # –ò–Ω–∞—á–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–≤–æ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —ç–∫—Å–ø–µ—Ä—Ç–∞
                expert = session.query(Expert).filter(
                    Expert.is_active == True
                ).first()
                
                if expert:
                    logger.info(f"üë§ –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–≤–æ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —ç–∫—Å–ø–µ—Ä—Ç–∞: {expert.name}")
                else:
                    logger.warning("‚ö†Ô∏è –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —ç–∫—Å–ø–µ—Ä—Ç–æ–≤")
                
                return expert
                
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —ç–∫—Å–ø–µ—Ä—Ç–∞ –Ω–µ–¥–µ–ª–∏: {e}")
            return None
    
    def set_expert_of_week(self, expert_id: int) -> bool:
        """
        –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —ç–∫—Å–ø–µ—Ä—Ç–∞ –Ω–µ–¥–µ–ª–∏.
        
        Args:
            expert_id: ID —ç–∫—Å–ø–µ—Ä—Ç–∞
            
        Returns:
            bool: True –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ
        """
        try:
            with self.get_session() as session:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç–∫—Å–ø–µ—Ä—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                expert = session.query(Expert).filter(Expert.id == expert_id).first()
                if expert:
                    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —ç–∫—Å–ø–µ—Ä—Ç–∞ –≤ –ø–∞–º—è—Ç–∏
                    self.selected_expert_id = expert_id
                    
                    logger.info(f"‚úÖ –≠–∫—Å–ø–µ—Ä—Ç –Ω–µ–¥–µ–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –ø–∞–º—è—Ç–∏: {expert.name} (ID: {expert.id})")
                    return True
                else:
                    logger.error(f"‚ùå –≠–∫—Å–ø–µ—Ä—Ç —Å ID {expert_id} –Ω–µ –Ω–∞–π–¥–µ–Ω")
                    return False
                
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —ç–∫—Å–ø–µ—Ä—Ç–∞ –Ω–µ–¥–µ–ª–∏: {e}")
            return False
    
    def get_expert_comments_for_news(self, news_ids: List[int]) -> Dict[int, Dict]:
        """
        –ü–æ–ª—É—á–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —ç–∫—Å–ø–µ—Ä—Ç–æ–≤ –∫ –Ω–æ–≤–æ—Å—Ç—è–º.
        
        Args:
            news_ids: –°–ø–∏—Å–æ–∫ ID –Ω–æ–≤–æ—Å—Ç–µ–π
            
        Returns:
            Dict[int, Dict]: –°–ª–æ–≤–∞—Ä—å {news_id: comment_data}
        """
        try:
            with self.get_session() as session:
                # –ü–æ–ª—É—á–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –Ω–æ–≤–æ—Å—Ç—è–º
                comments = session.query(Comment).filter(
                    Comment.news_id.in_(news_ids)
                ).all()
                
                # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ª–æ–≤–∞—Ä—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
                comments_dict = {}
                logger.info(f"üîç –ù–∞–π–¥–µ–Ω–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤: {len(comments)} –¥–ª—è –Ω–æ–≤–æ—Å—Ç–µ–π: {news_ids}")
                
                for comment in comments:
                    comments_dict[comment.news_id] = {
                        "text": comment.text,
                        "expert": {
                            "name": comment.expert.name if comment.expert else "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —ç–∫—Å–ø–µ—Ä—Ç",
                            "specialization": comment.expert.specialization if comment.expert else "AI"
                        }
                    }
                    logger.debug(f"üìù –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è –Ω–æ–≤–æ—Å—Ç–∏ {comment.news_id}: {comment.text[:50]}...")
                
                logger.info(f"‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ–º {len(comments_dict)} –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤")
                return comments_dict
                
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤: {e}")
            return {}
    
    def get_news_sources(self, news_ids: List[int]) -> Dict[int, List[str]]:
        """
        –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –Ω–æ–≤–æ—Å—Ç–µ–π.
        
        Args:
            news_ids: –°–ø–∏—Å–æ–∫ ID –Ω–æ–≤–æ—Å—Ç–µ–π
            
        Returns:
            Dict[int, List[str]]: –°–ª–æ–≤–∞—Ä—å {news_id: [source_names]}
        """
        try:
            with self.get_session() as session:
                # –ü–æ–ª—É—á–∞–µ–º –Ω–æ–≤–æ—Å—Ç–∏ —Å –∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏
                news_list = session.query(News).filter(
                    News.id.in_(news_ids)
                ).all()
                
                # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ª–æ–≤–∞—Ä—å –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
                sources_dict = {}
                
                for news in news_list:
                    # –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∏ —á–µ—Ä–µ–∑ —Å–≤—è–∑—å NewsSource
                    news_sources = session.query(NewsSource).filter(
                        NewsSource.news_id == news.id
                    ).all()
                    
                    logger.debug(f"üîç –ù–æ–≤–æ—Å—Ç—å {news.id}: –Ω–∞–π–¥–µ–Ω–æ {len(news_sources)} —Å–≤—è–∑–µ–π NewsSource")
                    
                    if news_sources:
                        # –ü–æ–ª—É—á–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ (—É–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã)
                        unique_sources = set()
                        for ns in news_sources:
                            source = session.query(Source).filter(Source.id == ns.source_id).first()
                            if source:
                                unique_sources.add(source)
                        
                        # –°–æ–∑–¥–∞–µ–º –æ–¥–Ω—É —Å—Å—ã–ª–∫—É –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫ (–ø–µ—Ä–≤—ã–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π)
                        if unique_sources:
                            source = list(unique_sources)[0]  # –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫
                            if source.telegram_id:
                                # –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ Telegram –∫–∞–Ω–∞–ª
                                if source.telegram_id.startswith('@'):
                                    source_link = f"[{source.name}](https://t.me/{source.telegram_id[1:]})"
                                else:
                                    source_link = f"[{source.name}](https://t.me/{source.telegram_id})"
                            else:
                                source_link = source.name
                            sources_dict[news.id] = [source_link]  # –û–¥–Ω–∞ —Å—Å—ã–ª–∫–∞ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫
                            logger.debug(f"‚úÖ –ù–æ–≤–æ—Å—Ç—å {news.id}: –∏—Å—Ç–æ—á–Ω–∏–∫ {source_link}")
                        else:
                            sources_dict[news.id] = ["–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫"]
                            logger.warning(f"‚ùå –ù–æ–≤–æ—Å—Ç—å {news.id}: –Ω–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤")
                    else:
                        # Fallback –¥–ª—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞–∑–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π
                        all_sources = session.query(Source).all()
                        if all_sources:
                            # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞–∑–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π
                            source_index = news.id % len(all_sources)
                            source = all_sources[source_index]
                            if source.telegram_id:
                                # –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ Telegram –∫–∞–Ω–∞–ª
                                if source.telegram_id.startswith('@'):
                                    source_link = f"[{source.name}](https://t.me/{source.telegram_id[1:]})"
                                else:
                                    source_link = f"[{source.name}](https://t.me/{source.telegram_id})"
                            else:
                                source_link = source.name
                            sources_dict[news.id] = [source_link]  # –û–¥–Ω–∞ —Å—Å—ã–ª–∫–∞ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫
                            logger.debug(f"‚ö†Ô∏è –ù–æ–≤–æ—Å—Ç—å {news.id}: fallback –∏—Å—Ç–æ—á–Ω–∏–∫ {source_link}")
                        else:
                            sources_dict[news.id] = ["–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫"]
                            logger.warning(f"‚ùå –ù–æ–≤–æ—Å—Ç—å {news.id}: –Ω–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤")
                
                logger.info(f"‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–ª—è {len(sources_dict)} –Ω–æ–≤–æ—Å—Ç–µ–π")
                return sources_dict
                
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤: {e}")
            return {}
